<!DOCTYPE html>

<body>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <script src="./py.js"></script>
    <script>
        let s = `\
    waiting for loading
    'r' to reset
    'c' to confirm
    's' to show cropped image on top left of the canvas (28 x 28)
        `
        console.log(s)

        pyodide = null

        async function main() {
            pyodide = await loadPyodide();
            await pyodide.loadPackage("numpy")
            await pyodide.loadPackage("pillow")
            // Pyodide is now ready to use...
            console.log(pyodide.runPython(`
                import sys
                sys.version
            `));
            is_load = true
        };
        main();


        function run_py() {
            let res = pyodide.runPython(script)
            alert(res)
        }

        // create canvas element and append it to document body
        var canvas = document.createElement('canvas');
        document.body.appendChild(canvas);

        // some hotfixes... ( ≖_≖)
        document.body.style.margin = 0;
        canvas.style.position = 'fixed';

        // get canvas 2D context and set him correct size
        var ctx = canvas.getContext('2d');
        resize();

        // last known position
        var pos = { x: 0, y: 0 };

        window.addEventListener('resize', resize);
        document.addEventListener('mousemove', draw);
        document.addEventListener('mousedown', setPosition);
        document.addEventListener('mouseenter', setPosition);
        document.addEventListener("keydown", (event) => {
            console.log(event.keyCode)
            if (event.keyCode === 82) {
                // reset
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            } else if (event.keyCode === 13 || event.keyCode === 67) {
                // confirm
                if (!is_load) {
                    alert("Loading")
                    return
                }

                arg = canvas.toDataURL("image/png").toString()
                run_py()
            } else if (event.keyCode == 68) {
                var image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream")  // here is the most important part because if you dont replace you will get a DOM 18 exception.

                window.location.href = image  // it will save locally
            } else if (event.keyCode == 83){
                arg = canvas.toDataURL("image/png").toString()
                
                let res = pyodide.runPython(script_crop)
                res = `data:image/png;base64,` + res

                var tmp_img = new Image()
                tmp_img.onload = () => {
                    ctx.drawImage(tmp_img, 0, 0)
                }
                tmp_img.src = res
                
            }
        });

        // new position from mouse event
        function setPosition(e) {
            pos.x = e.clientX;
            pos.y = e.clientY;
        }

        // resize canvas
        function resize() {
            ctx.canvas.width = window.innerWidth;
            ctx.canvas.height = window.innerHeight;
        }

        function draw(e) {
            // mouse left button must be pressed
            if (e.buttons !== 1) return;

            ctx.beginPath(); // begin

            ctx.lineWidth = 30;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000000';

            ctx.moveTo(pos.x, pos.y); // from
            setPosition(e);
            ctx.lineTo(pos.x, pos.y); // to

            ctx.stroke(); // draw it!
        }
    </script>
</body>